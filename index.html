<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bitcoin Tracker</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    body {font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; background: #f9f9f9; padding: 10px;}
    .box {background: white; padding: 15px; margin: 15px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
    button {padding: 10px 15px; margin: 5px; font-size: 16px; cursor: pointer;}
    input, select {padding: 8px; margin: 5px; font-size: 16px;}
    table {width: 100%; border-collapse: collapse; margin: 10px 0;}
    th, td {border: 1px solid #ccc; padding: 8px; text-align: center;}
    th {background: #f0f0f0;}
    #preco {font-size: 2.5em; font-weight: bold; color: #28a745; text-align: center;}
    #resumo {font-size: 1.3em; text-align: center; margin: 15px 0;}
    .aviso {color: red; font-weight: bold;}
    .ajuda {margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;}
  </style>
</head>
<body>

<h1 style="text-align:center;">Bitcoin Tracker</h1>

<div class="box">
  <div id="preco">Carregando preço...</div>
  <button onclick="atualizarPreco()">Atualizar Preço</button>
  <div id="resumo"></div>

  <h3>Nova Transação</h3>
  <select id="tipo">
    <option value="Compra">Compra</option>
    <option value="Venda">Venda</option>
    <option value="Transferência">Transferência</option>
    <option value="Presente">Presente</option>
    <option value="Taxa">Taxa</option>
  </select>

  <input type="number" id="sats" placeholder="Quantidade (sats)" min="1">
  <input type="number" id="valorBRL" placeholder="Valor em R$ (opcional para presente/taxa)">
  <input type="date" id="data">

  <div id="opcoesTransferencia" style="display:none; margin:10px 0;">
    <label><input type="radio" name="modoTransf" value="mercado" checked> Mercado (calcula sats pelo preço atual)</label><br>
    <label><input type="radio" name="modoTransf" value="manual"> Manual (digita sats + R$ recebidos)</label>
  </div>

  <input type="text" id="nota" placeholder="Nota (opcional)" style="width: 100%; margin: 10px 0;">
  <button onclick="adicionarTransacao()">Adicionar</button>
  <span id="avisoZero" class="aviso" style="display:none;">Atenção: Compra com R$ 0 não altera média!</span>
</div>

<div class="box">
  <h3>Histórico de Transações</h3>
  <div id="historico"></div>
</div>

<div class="box">
  <h3>Médias Mensais</h3>
  <table id="tabelaMedias">
    <thead><tr><th>Mês/Ano</th><th>Preço Médio (R$)</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="ajuda box">
  <h3>Ajuda - Como usar</h3>
  <select onchange="mostrarAjuda(this.value)">
    <option value="">Selecione um tópico</option>
    <option value="compra">Compra</option>
    <option value="venda">Venda</option>
    <option value="transferencia">Transferência</option>
    <option value="presente">Presente</option>
    <option value="taxa">Taxa</option>
    <option value="media">Média mensal</option>
  </select>
  <div id="textoAjuda" style="margin-top:10px;"></div>
</div>

<!-- BACKUP ENCRYPTED -->
<div class="box">
  <h2>Backup Automático Criptografado (a cada 5 dias)</h2>
  <div id="backupStatus">Carregando...</div>
  <button id="setupBtn">Configurar Email + Senha</button>
  <button id="backupNowBtn">Enviar Backup Agora</button>
</div>

<div class="box" style="border:2px solid red; background:#fff0f0;">
  <h2>Restaurar Backup</h2>
  <p>Selecione o arquivo <code>bitcoin-backup.enc</code> recebido por email:</p>
  <input type="file" accept=".enc" id="restoreFile">
</div>

<script>
// ==================== EMAILJS CONFIG (USE SMTP!) ====================
const EMAILJS_SERVICE_ID = 'service_qahcuvd';     
const EMAILJS_TEMPLATE_ID = 'template_fyrdqeg'; 
const EMAILJS_PUBLIC_KEY  = 'QCyeO60LnNiCyIsqx'; 
// ===================================================================

emailjs.init(EMAILJS_PUBLIC_KEY);

// ==================== ORIGINAL APP CODE (100% restored & fixed) ====================
let precoAtual = 0;
let transacoes = JSON.parse(localStorage.getItem('bitcoinData') || '[]');
let mediasMensais = JSON.parse(localStorage.getItem('mediasMensais') || '[]');

function atualizarPreco() {
  document.getElementById('preco').innerText = 'Carregando...';
  fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=brl')
    .then(r => r.json())
    .then(d => {
      precoAtual = d.bitcoin.brl || 0;
      document.getElementById('preco').innerHTML = `R$ ${precoAtual.toLocaleString('pt-BR', {minimumFractionDigits: 2})}

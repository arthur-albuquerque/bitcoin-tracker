<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-2xl font-bold text-center mb-6">Bitcoin Purchase Tracker</h1>

        <!-- Form for adding purchases or taxes -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Add Transaction</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="date" class="mt-1 block w-full p-2 border rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <select id="type" class="mt-1 block w-full p-2 border rounded-md" required>
                        <option value="purchase">Purchase</option>
                        <option value="tax">Tax</option>
                    </select>
                </div>
                <div id="purchaseFields">
                    <label class="block text-sm font-medium text-gray-700">Satoshis</label>
                    <input type="number" id="satoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 5000" required>
                    <label class="block text-sm font-medium text-gray-700 mt-2">Amount Paid (BRL)</label>
                    <input type="number" id="brl" min="0" step="0.01" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 100" required>
                </div>
                <div id="taxFields" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Tax Paid (Satoshis)</label>
                    <input type="number" id="taxSatoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 100" required>
                </div>
                <button onclick="addTransaction()" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Add Transaction</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Summary</h2>
            <p id="totalSats" class="text-gray-700">Total Satoshis: 0</p>
            <p id="totalBRL" class="text-gray-700">Total BRL Spent: 0.00</p>
            <p id="avgPrice" class="text-gray-700">Average Price: 0 BRL/BTC</p>
            <p id="livePrice" class="text-gray-700">Live Price: Loading...</p>
            <p id="profitLoss" class="text-gray-700">Profit/Loss: N/A</p>
        </div>

        <!-- Average Price Graph -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Average Price Over Time (BRL/BTC)</h2>
            <canvas id="avgPriceChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- Transaction History -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Transaction History</h2>
            <div id="history" class="space-y-2"></div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let chart;
        let livePrice = null;

        // Initialize form and load transactions
        document.addEventListener('DOMContentLoaded', () => {
            updateSummary();
            renderHistory();
            initChart();
            toggleFields();
            fetchLivePrice();
            setInterval(fetchLivePrice, 60000); // Update every 60 seconds
        });

        // Fetch live BRL/BTC price from Cointrader Monitor API
        async function fetchLivePrice() {
            console.log('Attempting to fetch live price...');
            try {
                const response = await fetch('https://cointradermonitor.com/api/pbb/v1/ticker', {
                    mode: 'cors',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (!data.last) throw new Error('Invalid API response: missing last price');
                livePrice = parseFloat(data.last).toFixed(2);
                console.log('Live price fetched:', livePrice);
                document.getElementById('livePrice').textContent = `Live Price: ${livePrice} BRL/BTC`;
                updateSummary(); // Recalculate profit/loss
            } catch (error) {
                console.error('Error fetching live price:', error.message);
                livePrice = null;
                document.getElementById('livePrice').textContent = `Live Price: Unavailable (Error: ${error.message})`;
                updateSummary();
                // Retry after 10 seconds if failed
                setTimeout(fetchLivePrice, 10000);
            }
        }

        // Toggle between purchase and tax fields
        document.getElementById('type').addEventListener('change', toggleFields);

        function toggleFields() {
            const type = document.getElementById('type').value;
            document.getElementById('purchaseFields').classList.toggle('hidden', type === 'tax');
            document.getElementById('taxFields').classList.toggle('hidden', type === 'purchase');
        }

        function addTransaction() {
            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value;
            let transaction;

            if (!date) {
                alert('Please select a date.');
                return;
            }

            if (type === 'purchase') {
                const satoshis = parseInt(document.getElementById('satoshis').value);
                const brl = parseFloat(document.getElementById('brl').value);
                if (isNaN(satoshis) || isNaN(brl) || satoshis <= 0 || brl < 0) {
                    alert('Please enter valid satoshis and BRL amounts.');
                    return;
                }
                transaction = { date, type, satoshis, brl };
            } else {
                const taxSatoshis = parseInt(document.getElementById('taxSatoshis').value);
                if (isNaN(taxSatoshis) || taxSatoshis <= 0) {
                    alert('Please enter a valid tax amount in satoshis.');
                    return;
                }
                transaction = { date, type, taxSatoshis };
            }

            transactions.push(transaction);
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateSummary();
            renderHistory();
            updateChart();
            resetForm();
        }

        function resetForm() {
            document.getElementById('date').value = '';
            document.getElementById('type').value = 'purchase';
            document.getElementById('satoshis').value = '';
            document.getElementById('brl').value = '';
            document.getElementById('taxSatoshis').value = '';
            toggleFields();
        }

        function updateSummary() {
            let totalSats = 0;
            let totalBRL = 0;

            transactions.forEach(t => {
                if (t.type === 'purchase') {
                    totalSats += t.satoshis;
                    totalBRL += t.brl;
                } else {
                    totalSats -= t.taxSatoshis;
                }
            });

            const total인을 = totalSats / 100000000; // Convert satoshis to BTC
            const avgPrice = totalBTC > 0 ? (totalBRL / totalBTC).toFixed(2) : 0;

            // Calculate profit/loss
            let profitLoss = 'N/A';
            if (livePrice && avgPrice > 0) {
                const percentage = ((livePrice - avgPrice) / avgPrice) * 100;
                profitLoss = percentage >= 0 ? `+${percentage.toFixed(2)}%` : `${percentage.toFixed(2)}%`;
            }

            document.getElementById('totalSats').textContent = `Total Satoshis: ${totalSats.toLocaleString()}`;
            document.getElementById('totalBRL').textContent = `Total BRL Spent: ${totalBRL.toFixed(2)}`;
            document.getElementById('avgPrice').textContent = `Average Price: ${avgPrice} BRL/BTC`;
            document.getElementById('profitLoss').textContent = `Profit/Loss: ${profitLoss}`;
        }

        function renderHistory() {
            const historyDiv = document.getElementById('history');
            historyDiv.innerHTML = '';
            transactions.forEach((t, index) => {
                const div = document.createElement('div');
                div.className = 'p-2 border-b';
                if (t.type === 'purchase') {
                    div.textContent = `${t.date}: Bought ${t.satoshis.toLocaleString()} sats for ${t.brl.toFixed(2)} BRL`;
                } else {
                    div.textContent = `${t.date}: Paid ${t.taxSatoshis.toLocaleString()} sats in taxes`;
                }
                historyDiv.appendChild(div);
            });
        }

        function initChart() {
            if (typeof Chart === 'undefined') {
                alert('Chart.js failed to load. Please check your internet connection and try again.');
                return;
            }

            const ctx = document.getElementById('avgPriceChart').getContext('2d');
            if (!ctx) {
                alert('Canvas element not found.');
                return;
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Price (BRL/BTC)',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Date' }
                        },
                        y: {
                            title: { display: true, text: 'Average Price (BRL/BTC)' },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
            updateChart();
        }

        function updateChart() {
            if (!chart) {
                console.log('Chart not initialized.');
                return;
            }

            let totalSats = 0;
            let totalBRL = 0;
            const labels = [];
            const avgPrices = [];

            transactions.forEach(t => {
                if (t.type === 'purchase') {
                    totalSats += t.satoshis;
                    totalBRL += t.brl;
                } else {
                    totalSats -= t.taxSatoshis;
                }

                const totalBTC = totalSats / 100000000;
                const avgPrice = totalBTC > 0 ? (totalBRL / totalBTC).toFixed(2) : 0;
                labels.push(t.date);
                avgPrices.push(avgPrice);
            });

            chart.data.labels = labels;
            chart.data.datasets[0].data = avgPrices;
            chart.update();
        }
    </script>
</body>
</html>
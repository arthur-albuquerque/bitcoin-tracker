<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-2xl font-bold text-center mb-6">Bitcoin Purchase Tracker</h1>

        <!-- Form for adding purchases, taxes, or transfers -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Add Transaction</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="date" class="mt-1 block w-full p-2 border rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <select id="type" class="mt-1 block w-full p-2 border rounded-md" required>
                        <option value="purchase">Purchase</option>
                        <option value="tax">Tax</option>
                        <option value="transfer">Transfer</option>
                    </select>
                </div>
                <div id="purchaseFields">
                    <label class="block text-sm font-medium text-gray-700">Satoshis</label>
                    <input type="number" id="satoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 5000" required>
                    <label class="block text-sm font-medium text-gray-700 mt-2">Amount Paid (BRL)</label>
                    <input type="number" id="brl" min="0" step="0.01" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 100" required>
                </div>
                <div id="taxFields" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Tax Paid (Satoshis)</label>
                    <input type="number" id="taxSatoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 100" required>
                </div>
                <div id="transferFields" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Transfer Method</label>
                    <select id="transferType" class="mt-1 block w-full p-2 border rounded-md">
                        <option value="market">Market Price</option>
                        <option value="manual">Manual Input</option>
                    </select>
                    <div id="marketTransferFields">
                        <label class="block text-sm font-medium text-gray-700 mt-2">BRL to Transfer</label>
                        <input type="number" id="transferBRL" min="0" step="0.01" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 700">
                        <p id="transferSatsDisplay" class="mt-1 text-sm text-gray-600">Equivalent: Waiting for live price...</p>
                    </div>
                    <div id="manualTransferFields" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mt-2">Satoshis to Transfer</label>
                        <input type="number" id="transferSatoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 130353">
                        <label class="block text-sm font-medium text-gray-700 mt-2">BRL Amount</label>
                        <input type="number" id="transferBRLManual" min="0" step="0.01" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 700">
                    </div>
                </div>
                <button id="addTransactionBtn" onclick="addTransaction()" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Add Transaction</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Summary</h2>
            <div class="mb-4">
                <p id="totalSats" class="text-gray-700"><strong>Total Satoshis:</strong> 0</p>
                <p id="totalBRL" class="text-gray-700"><strong>Total BRL Spent:</strong> 0.00</p>
                <p id="avgPrice" class="text-gray-700"><strong>Average Price:</strong> 0 BRL/BTC</p>
            </div>
            <div>
                <p id="livePrice" class="text-gray-700"><strong>Live Price:</strong> Loading...</p>
                <p id="currentValue" class="text-gray-700"><strong>Current Value:</strong> N/A</p>
                <p id="profitLoss" class="text-gray-700"><strong>Profit/Loss:</strong> N/A</p>
                <button onclick="fetchLivePrice()" class="mt-2 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Retry Live Price</button>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Transaction History</h2>
            <div id="history" class="space-y-2"></div>
        </div>

        <!-- Monthly Average Price Table -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Monthly Average Prices</h2>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2 border">Month/Year</th>
                        <th class="p-2 border">Average Price (BRL/BTC)</th>
                    </tr>
                </thead>
                <tbody id="monthlyPrices" class="text-gray-700"></tbody>
            </table>
        </div>

        <!-- Backup Data -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Backup Data</h2>
            <div class="space-y-4">
                <button onclick="exportData()" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Export Data</button>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Import Data</label>
                    <input type="file" id="importFile" accept=".json" class="mt-1 block w-full p-2 border rounded-md">
                    <button onclick="importData()" class="mt-2 w-full bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Import Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let monthlyPrices = JSON.parse(localStorage.getItem('monthlyPrices')) || [];
        let livePrice = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            alert('App loaded. Checking Cointrader price...');
            try {
                updateSummary();
                renderHistory();
                renderMonthlyPrices();
                checkMonthlyPriceUpdate();
                fetchLivePrice();
                setInterval(fetchLivePrice, 60000); // Update every 60 seconds
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error initializing app: ' + error.message);
            }
        });

        // Update transfer satoshis display for market transfers
        function updateTransferSatsDisplay() {
            const transferType = document.getElementById('transferType').value;
            const transferBRLInput = document.getElementById('transferBRL');
            const transferSatsDisplay = document.getElementById('transferSatsDisplay');
            const addTransactionBtn = document.getElementById('addTransactionBtn');
            if (!transferBRLInput || !transferSatsDisplay || !addTransactionBtn) return;

            if (transferType === 'market') {
                const transferBRL = parseFloat(transferBRLInput.value);
                if (livePrice && !isNaN(transferBRL) && transferBRL > 0) {
                    const transferSatoshis = Math.floor((transferBRL / livePrice) * 100000000);
                    transferSatsDisplay.textContent = `Equivalent: ${transferSatoshis.toLocaleString()} satoshis`;
                    addTransactionBtn.disabled = false;
                    addTransactionBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    addTransactionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    transferSatsDisplay.textContent = livePrice ? 'Enter BRL amount' : 'Live price required for market transfer';
                    addTransactionBtn.disabled = true;
                    addTransactionBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    addTransactionBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            } else {
                const transferSatoshis = parseInt(document.getElementById('transferSatoshis').value);
                const transferBRLManual = parseFloat(document.getElementById('transferBRLManual').value);
                if (!isNaN(transferSatoshis) && transferSatoshis > 0 && !isNaN(transferBRLManual) && transferBRLManual >= 0) {
                    addTransactionBtn.disabled = false;
                    addTransactionBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    addTransactionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    addTransactionBtn.disabled = true;
                    addTransactionBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    addTransactionBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            }
        }

        // Fetch live BRL/BTC price from Cointrader Monitor
        async function fetchLivePrice() {
            console.log('Fetching live price from Cointrader...');
            try {
                const url = 'https://cointradermonitor.com/api/pbb/v1/ticker';
                const response = await fetch(url, {
                    mode: 'cors',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (!data.last) throw new Error('Invalid Cointrader response: missing last price');
                livePrice = parseFloat(data.last).toFixed(2);
                console.log('Live price from Cointrader:', livePrice);
                document.getElementById('livePrice').innerHTML = `<strong>Live Price:</strong> ${livePrice} BRL/BTC`;
                updateSummary();
                checkMonthlyPriceUpdate();
                updateTransferSatsDisplay();
            } catch (error) {
                console.error('Error fetching live price:', error.message);
                livePrice = null;
                document.getElementById('livePrice').innerHTML = `<strong>Live Price:</strong> Not available`;
                updateSummary();
                updateTransferSatsDisplay();
                setTimeout(fetchLivePrice, 10000); // Retry after 10 seconds
            }
        }

        // Export data to a JSON file
        function exportData() {
            console.log('Exporting data...');
            try {
                const data = { transactions, monthlyPrices };
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bitcoin-tracker-backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('Data exported successfully');
                alert('Data exported as bitcoin-tracker-backup.json');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        // Import data from a JSON file
        function importData() {
            console.log('Importing data...');
            try {
                const fileInput = document.getElementById('importFile');
                if (!fileInput.files.length) {
                    alert('Please select a JSON file to import.');
                    console.log('No file selected');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!Array.isArray(data.transactions) || !Array.isArray(data.monthlyPrices)) {
                            throw new Error('Invalid file format: missing transactions or monthlyPrices arrays');
                        }
                        for (const t of data.transactions) {
                            if (!t.date || !t.type) {
                                throw new Error('Invalid transaction: missing date or type');
                            }
                            if (t.type === 'purchase' && (!t.satoshis || !t.brl || t.satoshis <= 0 || t.brl < 0)) {
                                throw new Error('Invalid purchase transaction: invalid satoshis or BRL');
                            }
                            if (t.type === 'tax' && (!t.taxSatoshis || t.taxSatoshis <= 0)) {
                                throw new Error('Invalid tax transaction: invalid taxSatoshis');
                            }
                            if (t.type === 'transfer') {
                                if (!t.transferSatoshis || t.transferSatoshis <= 0) {
                                    throw new Error('Invalid transfer transaction: invalid transferSatoshis');
                                }
                                if (!t.transferBRL) t.transferBRL = 0;
                                if (!t.transferType) t.transferType = 'market';
                            }
                        }
                        transactions = data.transactions;
                        monthlyPrices = data.monthlyPrices;
                        try {
                            localStorage.setItem('transactions', JSON.stringify(transactions));
                            localStorage.setItem('monthlyPrices', JSON.stringify(monthlyPrices));
                            console.log('Imported data saved to localStorage');
                        } catch (error) {
                            throw new Error('Error saving to localStorage: ' + error.message);
                        }
                        updateSummary();
                        renderHistory();
                        renderMonthlyPrices();
                        fileInput.value = '';
                        console.log('Data imported successfully');
                        alert('Data imported successfully');
                    } catch (error) {
                        console.error('Error parsing imported file:', error);
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.onerror = function() {
                    console.error('Error reading file');
                    alert('Error reading file');
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error in importData:', error);
                alert('Error importing data: ' + error.message);
            }
        }

        // Check and update monthly price table on the first day of the month
        function checkMonthlyPriceUpdate() {
            console.log('Checking monthly price update...');
            try {
                const today = new Date();
                if (today.getDate() !== 1) {
                    console.log('Not the first day of the month, skipping update');
                    return;
                }

                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const year = today.getFullYear();
                const monthYear = `${month}/${year}`;

                if (monthlyPrices.some(entry => entry.monthYear === monthYear)) {
                    console.log(`Entry for ${monthYear} already exists`);
                    return;
                }

                if (livePrice) {
                    monthlyPrices.push({ monthYear, price: parseFloat(livePrice) });
                    monthlyPrices.sort((a, b) => {
                        const [aMonth, aYear] = a.monthYear.split('/').map(Number);
                        const [bMonth, bYear] = b.monthYear.split('/').map(Number);
                        return aYear - bYear || aMonth - bMonth;
                    });
                    try {
                        localStorage.setItem('monthlyPrices', JSON.stringify(monthlyPrices));
                        console.log('Monthly price saved to localStorage');
                        renderMonthlyPrices();
                    } catch (error) {
                        console.error('localStorage error:', error);
                        alert('Error saving monthly price: ' + error.message);
                    }
                } else {
                    console.log('Live price not available, skipping monthly update');
                }
            } catch (error) {
                console.error('Error in checkMonthlyPriceUpdate:', error);
                alert('Error checking monthly price update: ' + error.message);
            }
        }

        // Render monthly prices table
        function renderMonthlyPrices() {
            console.log('Rendering monthly prices');
            try {
                const tbody = document.getElementById('monthlyPrices');
                tbody.innerHTML = '';
                monthlyPrices.forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 border">${entry.monthYear}</td>
                        <td class="p-2 border">${parseFloat(entry.price).toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error in renderMonthlyPrices:', error);
                alert('Error rendering monthly prices: ' + error.message);
            }
        }

        // Toggle between purchase, tax, and transfer fields
        document.getElementById('type').addEventListener('change', toggleFields);
        document.getElementById('transferType').addEventListener('change', toggleTransferFields);

        function toggleFields() {
            console.log('Toggling form fields');
            try {
                const type = document.getElementById('type').value;
                document.getElementById('purchaseFields').classList.toggle('hidden', type !== 'purchase');
                document.getElementById('taxFields').classList.toggle('hidden', type !== 'tax');
                document.getElementById('transferFields').classList.toggle('hidden', type !== 'transfer');
                if (type === 'transfer') toggleTransferFields();
                updateTransferSatsDisplay();
            } catch (error) {
                console.error('Error in toggleFields:', error);
                alert('Error toggling fields: ' + error.message);
            }
        }

        function toggleTransferFields() {
            console.log('Toggling transfer fields');
            try {
                const transferType = document.getElementById('transferType').value;
                document.getElementById('marketTransferFields').classList.toggle('hidden', transferType !== 'market');
                document.getElementById('manualTransferFields').classList.toggle('hidden', transferType !== 'manual');
                updateTransferSatsDisplay();
            } catch (error) {
                console.error('Error in toggleTransferFields:', error);
                alert('Error toggling transfer fields: ' + error.message);
            }
        }

        // Add event listeners for transfer inputs
        document.getElementById('transferBRL').addEventListener('input', updateTransferSatsDisplay);
        document.getElementById('transferSatoshis').addEventListener('input', updateTransferSatsDisplay);
        document.getElementById('transferBRLManual').addEventListener('input', updateTransferSatsDisplay);

        function addTransaction() {
            console.log('Add Transaction button clicked');
            try {
                const date = document.getElementById('date').value;
                const type = document.getElementById('type').value;
                let transaction;

                if (!date) {
                    alert('Please select a date.');
                    console.log('Validation failed: No date');
                    return;
                }

                if (type === 'purchase') {
                    const satoshis = parseInt(document.getElementById('satoshis').value);
                    const brl = parseFloat(document.getElementById('brl').value);
                    if (isNaN(satoshis) || isNaN(brl) || satoshis <= 0 || brl < 0) {
                        alert('Please enter valid satoshis and BRL amounts.');
                        console.log('Validation failed: Invalid satoshis or BRL');
                        return;
                    }
                    if (brl === 0) {
                        alert('Warning: Purchasing with 0 BRL affects average price calculations. Proceed with caution.');
                    }
                    transaction = { date, type, satoshis, brl };
                } else if (type === 'tax') {
                    const taxSatoshis = parseInt(document.getElementById('taxSatoshis').value);
                    if (isNaN(taxSatoshis) || taxSatoshis <= 0) {
                        alert('Please enter a valid tax amount in satoshis.');
                        console.log('Validation failed: Invalid tax satoshis');
                        return;
                    }
                    transaction = { date, type, taxSatoshis };
                } else if (type === 'transfer') {
                    const transferType = document.getElementById('transferType').value;
                    let transferSatoshis, transferBRL;

                    if (transferType === 'market') {
                        transferBRL = parseFloat(document.getElementById('transferBRL').value);
                        if (!livePrice) {
                            alert('Live price is required for market transfer transactions.');
                            console.log('Validation failed: No live price');
                            return;
                        }
                        if (isNaN(transferBRL) || transferBRL <= 0) {
                            alert('Please enter a valid BRL amount to transfer.');
                            console.log('Validation failed: Invalid transfer BRL');
                            return;
                        }
                        transferSatoshis = Math.floor((transferBRL / livePrice) * 100000000);
                        if (transferSatoshis <= 0) {
                            alert('Transfer amount too small to convert to satoshis.');
                            console.log('Validation failed: Transfer satoshis too small');
                            return;
                        }
                    } else {
                        transferSatoshis = parseInt(document.getElementById('transferSatoshis').value);
                        transferBRL = parseFloat(document.getElementById('transferBRLManual').value);
                        if (isNaN(transferSatoshis) || transferSatoshis <= 0) {
                            alert('Please enter a valid satoshi amount to transfer.');
                            console.log('Validation failed: Invalid transfer satoshis');
                            return;
                        }
                        if (isNaN(transferBRL) || transferBRL < 0) {
                            alert('Please enter a valid BRL amount.');
                            console.log('Validation failed: Invalid transfer BRL');
                            return;
                        }
                    }

                    let currentSats = 0;
                    let currentCostSats = 0;
                    let currentInternalBRL = 0;
                    let currentDisplayBRL = 0;
                    transactions.forEach(t => {
                        if (t.type === 'purchase') {
                            currentSats += t.satoshis;
                            if (t.brl > 0) {
                                currentCostSats += t.satoshis;
                                currentInternalBRL += t.brl;
                            }
                            currentDisplayBRL += t.brl;
                        } else if (t.type === 'tax') {
                            currentSats -= t.taxSatoshis;
                            currentCostSats -= t.taxSatoshis;
                            if (currentCostSats < 0) currentCostSats = 0;
                        } else if (t.type === 'transfer') {
                            currentSats -= t.transferSatoshis;
                            const avgPrice = currentCostSats > 0 ? (currentInternalBRL / (currentCostSats / 100000000)) : 0;
                            const brlToDeduct = parseFloat(((t.transferSatoshis / 100000000) * avgPrice).toFixed(2));
                            currentInternalBRL -= brlToDeduct;
                            currentCostSats -= t.transferSatoshis;
                            if (currentCostSats < 0) currentCostSats = 0;
                            currentDisplayBRL -= t.transferBRL || 0;
                        }
                    });
                    if (transferSatoshis > currentSats) {
                        alert('Insufficient satoshis for transfer.');
                        console.log('Validation failed: Insufficient satoshis');
                        return;
                    }
                    const currentAvgPrice = currentCostSats > 0 ? (currentInternalBRL / (currentCostSats / 100000000)) : 0;
                    const brlToDeduct = parseFloat(((transferSatoshis / 100000000) * currentAvgPrice).toFixed(2));
                    if (brlToDeduct > currentInternalBRL + 0.01) {
                        alert('Insufficient BRL cost basis for transfer.');
                        console.log('Validation failed: Insufficient BRL cost basis');
                        return;
                    }
                    if (transferBRL > currentDisplayBRL + 0.01) {
                        alert('Transfer BRL exceeds remaining BRL spent.');
                        console.log('Validation failed: Transfer BRL too high');
                        return;
                    }
                    transaction = { date, type, transferSatoshis, transferBRL, transferType };
                }

                console.log('Adding transaction:', transaction);
                transactions.push(transaction);
                transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                try {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    console.log('Transaction saved to localStorage');
                } catch (error) {
                    alert('Error saving transaction: ' + error.message);
                    console.error('localStorage error:', error);
                    return;
                }
                updateSummary();
                renderHistory();
                resetForm();
                console.log('Transaction added successfully');
            } catch (error) {
                alert('Error adding transaction: ' + error.message);
                console.error('Error in addTransaction:', error);
            }
        }

        function deleteTransaction(index) {
            console.log('Deleting transaction at index:', index);
            try {
                if (index < 0 || index >= transactions.length) {
                    alert('Invalid transaction index.');
                    console.log('Validation failed: Invalid index');
                    return;
                }
                transactions.splice(index, 1);
                try {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    console.log('Transaction deleted and saved to localStorage');
                } catch (error) {
                    alert('Error saving after deletion: ' + error.message);
                    console.error('localStorage error:', error);
                    return;
                }
                updateSummary();
                renderHistory();
                console.log('Transaction deleted successfully');
            } catch (error) {
                alert('Error deleting transaction: ' + error.message);
                console.error('Error in deleteTransaction:', error);
            }
        }

        function resetForm() {
            console.log('Resetting form');
            try {
                document.getElementById('date').value = '';
                document.getElementById('type').value = 'purchase';
                document.getElementById('satoshis').value = '';
                document.getElementById('brl').value = '';
                document.getElementById('taxSatoshis').value = '';
                document.getElementById('transferBRL').value = '';
                document.getElementById('transferSatoshis').value = '';
                document.getElementById('transferBRLManual').value = '';
                document.getElementById('transferType').value = 'market';
                toggleFields();
            } catch (error) {
                console.error('Error in resetForm:', error);
                alert('Error resetting form: ' + error.message);
            }
        }

        function updateSummary() {
            console.log('Updating summary');
            try {
                let totalSats = 0;
                let costSats = 0; // Satoshis with non-zero cost basis
                let displayBRL = 0;
                let internalBRL = 0;

                transactions.forEach(t => {
                    if (t.type === 'purchase') {
                        totalSats += t.satoshis;
                        displayBRL += t.brl;
                        if (t.brl > 0) {
                            costSats += t.satoshis;
                            internalBRL += t.brl;
                        }
                        console.log(`Purchase: totalSats=${totalSats}, costSats=${costSats}, internalBRL=${internalBRL}, displayBRL=${displayBRL}`);
                    } else if (t.type === 'tax') {
                        totalSats -= t.taxSatoshis;
                        costSats -= t.taxSatoshis;
                        if (costSats < 0) costSats = 0;
                        console.log(`Tax: totalSats=${totalSats}, costSats=${costSats}, internalBRL=${internalBRL}`);
                    } else if (t.type === 'transfer') {
                        const currentAvgPrice = costSats > 0 ? (internalBRL / (costSats / 100000000)) : 0;
                        const brlToDeduct = parseFloat(((t.transferSatoshis / 100000000) * currentAvgPrice).toFixed(2));
                        console.log(`Transfer: sats=${t.transferSatoshis}, brlToDeduct=${brlToDeduct}, internalBRL=${internalBRL}, costSats=${costSats}, avgPrice=${currentAvgPrice}`);
                        internalBRL = parseFloat((internalBRL - brlToDeduct).toFixed(2));
                        displayBRL -= t.transferBRL || 0;
                        totalSats -= t.transferSatoshis;
                        costSats -= t.transferSatoshis;
                        if (costSats < 0) costSats = 0;
                    }
                });

                if (totalSats < 0) {
                    console.error('Negative totalSats:', totalSats);
                    totalSats = 0;
                }
                if (costSats < 0) {
                    console.error('Negative costSats:', costSats);
                    costSats = 0;
                }
                if (displayBRL < -0.01) {
                    console.error('Negative displayBRL:', displayBRL);
                    displayBRL = 0;
                } else if (displayBRL < 0) {
                    displayBRL = 0;
                }
                if (internalBRL < -0.01) {
                    console.error('Negative internalBRL:', internalBRL);
                    internalBRL = 0;
                } else if (internalBRL < 0) {
                    internalBRL = 0;
                }

                if (totalSats === 0) {
                    displayBRL = 0;
                    internalBRL = 0;
                    costSats = 0;
                }

                const totalBTC = totalSats / 100000000;
                const avgPrice = totalBTC > 0 && internalBRL > 0 ? parseFloat((internalBRL / totalBTC).toFixed(0)) : 0;
                let currentValue = 'N/A';
                if (livePrice && totalSats > 0) {
                    currentValue = ((totalSats / 100000000) * parseFloat(livePrice)).toFixed(2);
                }
                let profitLoss = 'N/A';
                if (livePrice && avgPrice > 0 && totalSats > 0) {
                    const percentage = ((parseFloat(livePrice) - avgPrice) / avgPrice) * 100;
                    profitLoss = percentage >= 0 ? `+${percentage.toFixed(2)}%` : `${percentage.toFixed(2)}%`;
                }

                console.log(`Summary: totalSats=${totalSats}, costSats=${costSats}, displayBRL=${displayBRL}, internalBRL=${internalBRL}, avgPrice=${avgPrice}`);

                document.getElementById('totalSats').innerHTML = `<strong>Total Satoshis:</strong> ${totalSats.toLocaleString()}`;
                document.getElementById('totalBRL').innerHTML = `<strong>Total BRL Spent:</strong> ${displayBRL.toFixed(2)}`;
                document.getElementById('avgPrice').innerHTML = `<strong>Average Price:</strong> ${avgPrice.toLocaleString()} BRL/BTC`;
                document.getElementById('currentValue').innerHTML = `<strong>Current Value:</strong> ${currentValue} BRL`;
                document.getElementById('profitLoss').innerHTML = `<strong>Profit/Loss:</strong> ${profitLoss}`;
            } catch (error) {
                console.error('Error in updateSummary:', error);
                alert('Error updating summary: ' + error.message);
            }
        }

        function renderHistory() {
            console.log('Rendering history');
            try {
                const historyDiv = document.getElementById('history');
                historyDiv.innerHTML = '';
                transactions.forEach((t, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-2 border-b flex justify-between items-center';
                    let text;
                    if (t.type === 'purchase') {
                        text = `${t.date}: Bought ${t.satoshis.toLocaleString()} sats for ${t.brl.toFixed(2)} BRL`;
                    } else if (t.type === 'tax') {
                        text = `${t.date}: Paid ${t.taxSatoshis.toLocaleString()} sats in taxes`;
                    } else if (t.type === 'transfer') {
                        const methodText = t.transferType === 'manual' ? 'manually' : 'at market price';
                        text = `${t.date}: Transferred ${t.transferSatoshis.toLocaleString()} sats (${t.transferBRL.toFixed(2)} BRL ${methodText})`;
                    }
                    div.innerHTML = `
                        <span>${text}</span>
                        <button onclick="deleteTransaction(${index})" class="bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700">Delete</button>
                    `;
                    historyDiv.appendChild(div);
                });
            } catch (error) {
                console.error('Error in renderHistory:', error);
                alert('Error rendering history: ' + error.message);
            }
        }
    </script>
</body>
</html>

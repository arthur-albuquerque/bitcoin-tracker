<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bitcoin Tracker - Arthur Albuquerque</title>
  <style>
    body {font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; background:#f9f9f9; padding:10px;}
    .box {background:white; padding:15px; margin:15px 0; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    button {padding:8px 12px; margin:3px; font-size:14px; cursor:pointer; background:#007bff; color:white; border:none; border-radius:4px;}
    button.del {background:#dc3545; font-size:12px;}
    input, select {padding:8px; margin:5px; font-size:16px;}
    #preco {font-size:2.5em; font-weight:bold; color:#28a745; text-align:center;}
    #resumo {font-size:1.3em; text-align:center; margin:15px 0;}
    .aviso {color:red; font-weight:bold;}
    .transacao {margin:8px 0; padding:10px; background:#f8f9fa; border-radius:6px; display:flex; justify-content:space-between; align-items:center;}
  </style>
</head>
<body>

<h1 style="text-align:center;">Bitcoin Tracker</h1>

<div class="box">
  <div id="preco">Carregando preço...</div>
  <button id="btnAtualizar">Atualizar Preço</button>
  <div id="resumo"></div>

  <h3>Nova Transação</h3>
  <select id="tipo">
    <option value="Compra">Compra</option>
    <option value="Venda">Venda</option>
    <option value="Transferência">Transferência</option>
    <option value="Presente">Presente</option>
    <option value="Taxa">Taxa</option>
  </select>
  <input type="number" id="sats" placeholder="Quantidade (sats)" min="1">
  <input type="number" id="valorBRL" placeholder="Valor em R$ (opcional)">
  <input type="date" id="data">
  <div id="opcoesTransferencia" style="display:none; margin:10px 0;">
    <label><input type="radio" name="modoTransf" value="mercado" checked> Mercado</label><br>
    <label><input type="radio" name="modoTransf" value="manual"> Manual</label>
  </div>
  <input type="text" id="nota" placeholder="Nota (opcional)" style="width:100%; margin:10px 0;">
  <button id="btnAdicionar">Adicionar</button>
  <span id="avisoZero" class="aviso" style="display:none;">Compra com R$ 0 não altera média!</span>
</div>

<div class="box">
  <h3>Histórico de Transações</h3>
  <div id="historico"></div>
</div>

<div class="box">
  <h3>Médias Mensais</h3>
  <table id="tabelaMedias"><thead><tr><th>Mês/Ano</th><th>Preço Médio (R$)</th></tr></thead><tbody></tbody></table>
</div>

<div class="box">
  <h2>Backup Criptografado (a cada 5 dias)</h2>
  <div id="backupStatus">Carregando...</div>
  <button id="setupBtn">Configurar Email + Senha</button>
  <button id="backupNowBtn">Enviar Backup Agora</button>
</div>

<div class="box" style="border:2px solid red; background:#fff0f0;">
  <h2>Restaurar Backup</h2>
  <p>Selecione o arquivo <code>bitcoin-backup.enc</code>:</p>
  <input type="file" accept=".enc" id="restoreFile">
</div>

<script>
// ==================== FORMSPREE (FREE + ALWAYS ATTACHMENTS) ====================
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/mjknprye'; 
// ===================================================================

let precoAtual = 0;
let transacoes = JSON.parse(localStorage.getItem('bitcoinData') || '[]');
let mediasMensais = JSON.parse(localStorage.getItem('mediasMensais') || '[]');

function atualizarPreco() {
  document.getElementById('preco').innerText = 'Carregando...';
  fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=brl')
    .then(r => r.json())
    .then(d => {
      precoAtual = d.bitcoin.brl || 0;
      document.getElementById('preco').innerHTML = `R$ ${precoAtual.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
      calcularResumo();
      salvarMediaMensalSeNecessario();
    });
}

function salvarMediaMensalSeNecessario() {
  const hoje = new Date();
  if (hoje.getDate() !== 1) return;
  const mesAno = hoje.toLocaleDateString('pt-BR', {month:'short', year:'numeric'});
  if (mediasMensais.some(m => m.mes === mesAno)) return;
  mediasMensais.unshift({mes: mesAno, preco: precoAtual});
  localStorage.setItem('mediasMensais', JSON.stringify(mediasMensais));
  atualizarTabelaMedias();
}

function calcularResumo() {
  let totalSats = 0, totalGasto = 0, satsComprados = 0;
  transacoes.forEach(t => {
    const sats = parseInt(t.sats) || 0;
    const brl = parseFloat(t.valorBRL) || 0;
    if (['Compra','Presente'].includes(t.tipo)) {
      totalSats += sats;
      if (t.tipo === 'Compra') { satsComprados += sats; totalGasto += brl; }
    } else if (['Venda','Taxa'].includes(t.tipo)) totalSats -= sats;
  });
  const media = satsComprados > 0 ? totalGasto / (satsComprados/100000000) : 0;
  const valorAtual = totalSats/100000000 * precoAtual;
  const lucro = valorAtual - totalGasto;
  const lucroPercent = totalGasto > 0 ? ((lucro / totalGasto) * 100).toFixed(2) : '0.00';

  document.getElementById('resumo').innerHTML = `
    Total: <strong>${(totalSats/100000000).toFixed(8)} BTC</strong> (${totalSats.toLocaleString()} sats)<br>
    Investido: <strong>R$ ${totalGasto.toFixed(2)}</strong> | Média: <strong>R$ ${media.toFixed(2)}</strong><br>
    Valor atual: <strong>R$ ${valorAtual.toFixed(2)}</strong><br>
    Lucro/Prejuízo: <strong style="color:${lucro>=0?'green':'red'}">
      R$ ${lucro.toFixed(2)} (${lucro>=0?'+':''}${lucroPercent}%)
    </strong>
  `;
}

function adicionarTransacao() {
  const tipo = document.getElementById('tipo').value;
  const sats = document.getElementById('sats').value;
  const valorBRL = document.getElementById('valorBRL').value || '0';
  const data = document.getElementById('data').value || new Date().toISOString().split('T')[0];
  const nota = document.getElementById('nota').value;

  if (!sats || parseInt(sats)<=0) return alert('Quantidade inválida');
  if (['Compra','Venda'].includes(tipo) && parseFloat(valorBRL)===0) {
    document.getElementById('avisoZero').style.display='block';
    setTimeout(()=>document.getElementById('avisoZero').style.display='none',5000);
  }

  transacoes.push({tipo, sats, valorBRL, data, nota});
  localStorage.setItem('bitcoinData', JSON.stringify(transacoes));
  atualizarHistorico();
  calcularResumo();
  document.getElementById('sats').value = document.getElementById('valorBRL').value = document.getElementById('nota').value = '';
}

function atualizarHistorico() {
  const div = document.getElementById('historico');
  div.innerHTML = '';
  transacoes.slice().reverse().forEach((t, index) => {
    const originalIndex = transacoes.length - 1 - index;
    const item = document.createElement('div');
    item.className = 'transacao';
    item.innerHTML = `
      <span><strong>${t.data}</strong> - ${t.tipo}: ${parseInt(t.sats).toLocaleString()} sats 
      ${parseFloat(t.valorBRL)>0?` | R$ ${parseFloat(t.valorBRL).toFixed(2)}`:''} 
      ${t.nota?` | <em>${t.nota}</em>`:''}</span>
      <button class="del" data-index="${originalIndex}">Apagar</button>
    `;
    div.appendChild(item);
  });
  document.querySelectorAll('.del').forEach(b=>b.onclick=()=> {
    if(confirm('Apagar?')) {
      transacoes.splice(parseInt(b.dataset.index),1);
      localStorage.setItem('bitcoinData', JSON.stringify(transacoes));
      atualizarHistorico(); calcularResumo();
    }
  });
}

function atualizarTabelaMedias() {
  const tbody = document.querySelector('#tabelaMedias tbody');
  tbody.innerHTML = '';
  mediasMensais.forEach(m => {
    const tr = tbody.insertRow();
    tr.insertCell(0).textContent = m.mes;
    tr.insertCell(1).textContent = `R$ ${m.preco.toLocaleString('pt-BR',{minimumFractionDigits:2})}`;
  });
}

// ==================== BACKUP VIA FORMSPREE (FREE + ALWAYS ATTACHMENTS) ====================
async function deriveKey(pw) {
  const enc = new TextEncoder();
  let salt = localStorage.getItem('backupSalt');
  if (!salt) { salt = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16)))); localStorage.setItem('backupSalt', salt); }
  const sb = Uint8Array.from(atob(salt),c=>c.charCodeAt(0));
  const bk = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
  return await crypto.subtle.deriveKey({name:'PBKDF2',salt:sb,iterations:200000,hash:'SHA-256'}, bk, {name:'AES-GCM',length:256}, true, ['encrypt','decrypt']);
}

async function sendBackup() {
  const email = localStorage.getItem('backupEmail');
  const pass = localStorage.getItem('backupKey');
  if (!email || !pass) return alert('Configure o backup primeiro!');

  try {
    const key = await deriveKey(pass);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const data = JSON.stringify({transacoes, mediasMensais}, null, 2);
    const enc = await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, new TextEncoder().encode(data));
    const combined = new Uint8Array(iv.byteLength + enc.byteLength);
    combined.set(iv,0); combined.set(new Uint8Array(enc),iv.byteLength);
    const file = new File([combined], 'bitcoin-backup.enc', {type:'application/octet-stream'});

    const fd = new FormData();
    fd.append('email', email);
    fd.append('subject', 'Backup Bitcoin Tracker - ' + new Date().toLocaleDateString('pt-BR'));
    fd.append('message', 'Seu backup criptografado está anexado.');
    fd.append('attachment', file);

    const r = await fetch(FORMSPREE_ENDPOINT, {method:'POST', body:fd});
    if (r.ok) {
      localStorage.setItem('lastBackup', Date.now().toString());
      document.getElementById('backupStatus').innerHTML = `Último: ${new Date().toLocaleString('pt-BR')}`;
      alert('Backup enviado COM anexo!');
    } else throw new Error('Erro');
  } catch(e) { alert('Erro no backup: '+e.message); }
}

// ==================== EVENTS & INIT ====================
document.getElementById('btnAtualizar').onclick = atualizarPreco;
document.getElementById('btnAdicionar').onclick = adicionarTransacao;
document.getElementById('tipo').onchange = () => document.getElementById('opcoesTransferencia').style.display = document.getElementById('tipo').value==='Transferência'?'block':'none';
document.getElementById('setupBtn').onclick = () => {
  const e = prompt('Seu email:', localStorage.getItem('backupEmail')||'');
  if (!e?.includes('@')) return alert('Email inválido');
  const p = prompt('Senha forte:');
  if (!p || p.length<8) return alert('Senha fraca');
  localStorage.setItem('backupEmail', e);
  localStorage.setItem('backupKey', p);
  localStorage.removeItem('backupSalt');
  document.getElementById('backupStatus').innerHTML = `Configurado: ${e}`;
  alert('Backup configurado!');
};
document.getElementById('backupNowBtn').onclick = sendBackup;
document.getElementById('restoreFile').onchange = async e => {
  const f = e.target.files[0]; if (!f) return;
  const p = localStorage.getItem('backupKey'); if (!p) return alert('Configure a senha!');
  const ep = prompt('Senha:'); if (ep !== p) return alert('Senha errada!');
  try {
    const d = new Uint8Array(await f.arrayBuffer());
    const iv = d.slice(0,12), ct = d.slice(12);
    const k = await deriveKey(ep);
    const dec = await crypto.subtle.decrypt({name:'AES-GCM',iv}, k, ct);
    const {transacoes:t, mediasMensais:m} = JSON.parse(new TextDecoder().decode(dec));
    transacoes = t; mediasMensais = m;
    localStorage.setItem('bitcoinData', JSON.stringify(t));
    localStorage.setItem('mediasMensais', JSON.stringify(m));
    location.reload();
  } catch { alert('Restauração falhou'); }
};

window.onload = () => {
  document.getElementById('backupStatus').innerHTML = localStorage.getItem('backupEmail') 
    ? `Enviando para: ${localStorage.getItem('backupEmail')}` 
    : 'Backup não configurado';
  atualizarTabelaMedias();
  atualizarHistorico();
  atualizarPreco();
  calcularResumo();
};
</script>
</body>
</html>

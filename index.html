<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bitcoin Tracker</title>

  <!-- EmailJS (free, no server needed) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 20px; 
      background: #f4f4f4; 
    }
    .box { 
      background: white; 
      padding: 20px; 
      margin: 20px 0; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }
    button { 
      padding: 10px 16px; 
      margin: 5px; 
      font-size: 16px; 
      cursor: pointer; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
    }
    button:disabled { 
      background: #ccc; 
    }
    input[type=file] { 
      margin: 10px 0; 
    }
    h1, h2 { 
      text-align: center; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 20px 0; 
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 8px; 
      text-align: left; 
    }
    th { 
      background-color: #f2f2f2; 
    }
    #price { 
      font-size: 2em; 
      font-weight: bold; 
      text-align: center; 
      color: #28a745; 
    }
    .loading { 
      text-align: center; 
      color: #666; 
    }
  </style>
</head>
<body>

  <h1>Bitcoin Tracker</h1>

  <!-- YOUR ORIGINAL TRACKER UI -->
  <div class="box">
    <div id="price" class="loading">Loading Bitcoin price...</div>
    <button id="refreshBtn">Refresh Price</button>
    <h3>Price History</h3>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Price (USD)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be populated here -->
      </tbody>
    </table>
  </div>

  <!-- BACKUP SECTION -->
  <div class="box">
    <h2>Auto Email Backup (every 5 days)</h2>
    <div id="backupStatus">
      Loading backup status...
    </div>
    <button id="setupBtn">Setup / Change Email & Password</button>
    <button id="backupNowBtn">Send Backup Now</button>
  </div>

  <!-- RESTORE SECTION -->
  <div class="box" style="border: 2px solid #c00; background:#fff3f3;">
    <h2>Restore from Backup</h2>
    <p>Select the <code>bitcoin-backup.enc</code> file from your email:</p>
    <input type="file" accept=".enc" id="restoreFile" />
    <div id="restoreStatus"></div>
  </div>

<script>
// ────────────────────── CONFIGURE EMAILJS HERE ──────────────────────
const EMAILJS_SERVICE_ID = 'service_qahcuvd';     
const EMAILJS_TEMPLATE_ID = 'template_fyrdqeg'; 
const EMAILJS_PUBLIC_KEY  = 'QCyeO60LnNiCyIsqx';  
// ─────────────────────────────────────────────────────────────────────

emailjs.init(EMAILJS_PUBLIC_KEY);

// ────────────────────── BITCOIN TRACKER FUNCTIONALITY ──────────────────────
// (Your original code - fetches price and stores history in localStorage 'bitcoinData')

let history = JSON.parse(localStorage.getItem('bitcoinData') || '[]');

function updatePrice() {
  document.getElementById('price').innerHTML = 'Fetching...';
  
  fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')
    .then(response => response.json())
    .then(data => {
      const price = data.bitcoin.usd;
      const now = new Date().toLocaleString();
      
      document.getElementById('price').innerHTML = `$${price.toLocaleString()}`;
      
      // Add to history (keep last 100 entries)
      history.unshift({ date: now, price: price });
      if (history.length > 100) history = history.slice(0, 100);
      localStorage.setItem('bitcoinData', JSON.stringify(history));
      
      updateHistoryTable();
    })
    .catch(err => {
      console.error(err);
      document.getElementById('price').innerHTML = 'Error fetching price';
    });
}

function updateHistoryTable() {
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  
  history.forEach(entry => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = entry.date;
    row.insertCell(1).textContent = `$${entry.price.toLocaleString()}`;
  });
}

// Event listeners for tracker
document.getElementById('refreshBtn').onclick = updatePrice;

// ────────────────────── BACKUP & RESTORE ──────────────────────

// Helper: get your tracker data (now it's the history array)
function getBackupData() {
  return JSON.stringify(history, null, 2);
}

// Derive key from password (same every time thanks to stored salt)
async function deriveKey(password) {
  const enc = new TextEncoder();
  let salt = localStorage.getItem('backupSalt');
  if (!salt) {
    salt = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16))));
    localStorage.setItem('backupSalt', salt);
  }
  const saltBytes = Uint8Array.from(atob(salt), c => c.charCodeAt(0));

  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: saltBytes, iterations: 200000, hash: 'SHA-256' },
    baseKey,
    { name: 'AES-GCM', length: 256 },
    true,
    ['encrypt', 'decrypt']
  );
}

// Send encrypted backup
async function sendBackup() {
  const email = localStorage.getItem('backupEmail');
  const pass  = localStorage.getItem('backupKey');
  if (!email || !pass) return alert('Please set up backup first!');

  try {
    const key = await deriveKey(pass);
    const iv  = crypto.getRandomValues(new Uint8Array(12));
    const data = getBackupData();

    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      key,
      new TextEncoder().encode(data)
    );

    const combined = new Uint8Array(iv.byteLength + encrypted.byteLength);
    combined.set(iv, 0);
    combined.set(new Uint8Array(encrypted), iv.byteLength);

    const file = new File([combined], 'bitcoin-backup.enc', { type: 'application/octet-stream' });

    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      to_email: email,
      date: new Date().toLocaleString(),
    }, { attachments: [file] });

    localStorage.setItem('lastBackup', Date.now().toString());
    updateStatus();
    alert('Encrypted backup sent to ' + email + '!');
  } catch (e) {
    console.error(e);
    alert('Backup failed: ' + e.message);
  }
}

// Update status text
function updateStatus() {
  const email = localStorage.getItem('backupEmail') || 'Not set';
  const last  = localStorage.getItem('lastBackup');
  const text  = last ? new Date(parseInt(last)).toLocaleString() : 'Never';

  document.getElementById('backupStatus').innerHTML = `
    Sending to: <strong>${email}</strong><br>
    Last backup: <strong>${text}</strong>
  `;
}

// Setup button
document.getElementById('setupBtn').onclick = () => {
  const email = prompt('Your email for backups:', localStorage.getItem('backupEmail') || '');
  if (!email || !email.includes('@')) return alert('Invalid email');

  const pass = prompt('Choose a strong password:');
  if (!pass || pass.length < 8) return alert('Password too weak');

  localStorage.setItem('backupEmail', email);
  localStorage.setItem('backupKey', pass);
  localStorage.removeItem('backupSalt'); // force new salt
  updateStatus();
  alert('Backup setup complete!');
};

document.getElementById('backupNowBtn').onclick = sendBackup;

// Restore from file
document.getElementById('restoreFile').onchange = async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const pass = localStorage.getItem('backupKey');
  if (!pass) return alert('Set up your password first!');

  const entered = prompt('Enter your backup password:');
  if (entered !== pass) return alert('Wrong password!');

  try {
    const buf = await file.arrayBuffer();
    const data = new Uint8Array(buf);
    const iv = data.slice(0, 12);
    const ciphertext = data.slice(12);

    const key = await deriveKey(entered);
    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext);
    const json = new TextDecoder().decode(decrypted);

    history = JSON.parse(json);
    localStorage.setItem('bitcoinData', JSON.stringify(history));
    updateHistoryTable();
    alert('Backup restored successfully!');
  } catch (err) {
    alert('Decryption failed – wrong password or damaged file.');
  }
};

// ────────────────────── INITIALIZATION ──────────────────────
window.onload = () => {
  updateStatus();
  updateHistoryTable();
  updatePrice(); // Initial load

  // Auto-check every 5 days when page loads
  const last = localStorage.getItem('lastBackup');
  const fiveDays = 5 * 24 * 60 * 60 * 1000;
  if (localStorage.getItem('backupEmail') && localStorage.getItem('backupKey') &&
      (!last || Date.now() - parseInt(last) > fiveDays)) {
    if (confirm('Time for your 5-day backup! Send now?')) sendBackup();
  }
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-2xl font-bold text-center mb-6">Bitcoin Purchase Tracker</h1>

        <!-- Form for adding purchases or taxes -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Add Transaction</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="date" class="mt-1 block w-full p-2 border rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <select id="type" class="mt-1 block w-full p-2 border rounded-md" required>
                        <option value="purchase">Purchase</option>
                        <option value="tax">Tax</option>
                    </select>
                </div>
                <div id="purchaseFields">
                    <label class="block text-sm font-medium text-gray-700">Satoshis</label>
                    <input type="number" id="satoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 5000" required>
                    <label class="block text-sm font-medium text-gray-700 mt-2">Amount Paid (BRL)</label>
                    <input type="number" id="brl" min="0" step="0.01" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 100" required>
                </div>
                <div id="taxFields" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Tax Paid (Satoshis)</label>
                    <input type="number" id="taxSatoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 100" required>
                </div>
                <button onclick="addTransaction()" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Add Transaction</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Summary</h2>
            <p id="totalSats" class="text-gray-700">Total Satoshis: 0</p>
            <p id="totalBRL" class="text-gray-700">Total BRL Spent: 0.00</p>
            <p id="avgPrice" class="text-gray-700">Average Price: 0 BRL/BTC</p>
            <p id="livePrice" class="text-gray-700">Live Price: Loading...</p>
            <p id="profitLoss" class="text-gray-700">Profit/Loss: N/A</p>
            <button onclick="fetchLivePrice()" class="mt-2 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Retry Live Price</button>
        </div>

        <!-- Transaction History -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Transaction History</h2>
            <div id="history" class="space-y-2"></div>
        </div>

        <!-- Monthly Average Price Table -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Monthly Average Prices</h2>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2 border">Month/Year</th>
                        <th class="p-2 border">Average Price (BRL/BTC)</th>
                    </tr>
                </thead>
                <tbody id="monthlyPrices" class="text-gray-700"></tbody>
            </table>
        </div>

        <!-- Backup Data -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Backup Data</h2>
            <div class="space-y-4">
                <button onclick="exportData()" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Export Data</button>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Import Data</label>
                    <input type="file" id="importFile" accept=".json" class="mt-1 block w-full p-2 border rounded-md">
                    <button onclick="importData()" class="mt-2 w-full bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Import Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let monthlyPrices = JSON.parse(localStorage.getItem('monthlyPrices')) || [];
        let livePrice = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            alert('App loaded. Checking Cointrader price...');
            try {
                updateSummary();
                renderHistory();
                renderMonthlyPrices();
                checkMonthlyPriceUpdate();
                fetchLivePrice();
                setInterval(fetchLivePrice, 60000); // Update every 60 seconds
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error initializing app: ' + error.message);
            }
        });

        // Fetch live BRL/BTC price from Cointrader Monitor
        async function fetchLivePrice() {
            console.log('Fetching live price from Cointrader...');
            try {
                const url = 'https://cointradermonitor.com/api/pbb/v1/ticker';
                const response = await fetch(url, {
                    mode: 'cors',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (!data.last) throw new Error('Invalid Cointrader response: missing last price');
                livePrice = parseFloat(data.last).toFixed(2);
                console.log('Live price from Cointrader:', livePrice);
                document.getElementById('livePrice').textContent = `Live Price: ${livePrice} BRL/BTC`;
                updateSummary();
                checkMonthlyPriceUpdate(); // Check if price needs to be added to table
            } catch (error) {
                console.error('Error fetching live price:', error.message);
                livePrice = null;
                document.getElementById('livePrice').textContent = 'Live Price: Not available';
                updateSummary();
                setTimeout(fetchLivePrice, 10000); // Retry after 10 seconds
            }
        }

        // Export data to a JSON file
        function exportData() {
            console.log('Exporting data...');
            try {
                const data = { transactions, monthlyPrices };
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bitcoin-tracker-backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('Data exported successfully');
                alert('Data exported as bitcoin-tracker-backup.json');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        // Import data from a JSON file
        function importData() {
            console.log('Importing data...');
            try {
                const fileInput = document.getElementById('importFile');
                if (!fileInput.files.length) {
                    alert('Please select a JSON file to import.');
                    console.log('No file selected');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!Array.isArray(data.transactions) || !Array.isArray(data.monthlyPrices)) {
                            throw new Error('Invalid file format: missing transactions or monthlyPrices arrays');
                        }
                        transactions = data.transactions;
                        monthlyPrices = data.monthlyPrices;
                        try {
                            localStorage.setItem('transactions', JSON.stringify(transactions));
                            localStorage.setItem('monthlyPrices', JSON.stringify(monthlyPrices));
                            console.log('Imported data saved to localStorage');
                        } catch (error) {
                            throw new Error('Error saving to localStorage: ' + error.message);
                        }
                        updateSummary();
                        renderHistory();
                        renderMonthlyPrices();
                        fileInput.value = ''; // Clear file input
                        console.log('Data imported successfully');
                        alert('Data imported successfully');
                    } catch (error) {
                        console.error('Error parsing imported file:', error);
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.onerror = function() {
                    console.error('Error reading file');
                    alert('Error reading file');
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error in importData:', error);
                alert('Error importing data: ' + error.message);
            }
        }

        // Check and update monthly price table on the first day of the month
        function checkMonthlyPriceUpdate() {
            console.log('Checking monthly price update...');
            try {
                const today = new Date();
                if (today.getDate() !== 1) {
                    console.log('Not the first day of the month, skipping update');
                    return;
                }

                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const year = today.getFullYear();
                const monthYear = `${month}/${year}`;

                // Check if entry for this month/year already exists
                if (monthlyPrices.some(entry => entry.monthYear === monthYear)) {
                    console.log(`Entry for ${monthYear} already exists`);
                    return;
                }

                // Add new entry only if live price is available
                if (livePrice) {
                    monthlyPrices.push({ monthYear, price: parseFloat(livePrice) });
                    monthlyPrices.sort((a, b) => {
                        const [aMonth, aYear] = a.monthYear.split('/').map(Number);
                        const [bMonth, bYear] = b.monthYear.split('/').map(Number);
                        return aYear - bYear || aMonth - bMonth;
                    });
                    try {
                        localStorage.setItem('monthlyPrices', JSON.stringify(monthlyPrices));
                        console.log('Monthly price saved to localStorage');
                        renderMonthlyPrices();
                    } catch (error) {
                        console.error('localStorage error:', error);
                        alert('Error saving monthly price: ' + error.message);
                    }
                } else {
                    console.log('Live price not available, skipping monthly update');
                }
            } catch (error) {
                console.error('Error in checkMonthlyPriceUpdate:', error);
                alert('Error checking monthly price update: ' + error.message);
            }
        }

        // Render monthly prices table
        function renderMonthlyPrices() {
            console.log('Rendering monthly prices');
            try {
                const tbody = document.getElementById('monthlyPrices');
                tbody.innerHTML = '';
                monthlyPrices.forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 border">${entry.monthYear}</td>
                        <td class="p-2 border">${parseFloat(entry.price).toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error in renderMonthlyPrices:', error);
                alert('Error rendering monthly prices: ' + error.message);
            }
        }

        // Toggle between purchase and tax fields
        document.getElementById('type').addEventListener('change', toggleFields);

        function toggleFields() {
            console.log('Toggling form fields');
            try {
                const type = document.getElementById('type').value;
                document.getElementById('purchaseFields').classList.toggle('hidden', type === 'tax');
                document.getElementById('taxFields').classList.toggle('hidden', type === 'purchase');
            } catch (error) {
                console.error('Error in toggleFields:', error);
                alert('Error toggling fields: ' + error.message);
            }
        }

        function addTransaction() {
            console.log('Add Transaction button clicked');
            try {
                const date = document.getElementById('date').value;
                const type = document.getElementById('type').value;
                let transaction;

                if (!date) {
                    alert('Please select a date.');
                    console.log('Validation failed: No date');
                    return;
                }

                if (type === 'purchase') {
                    const satoshis = parseInt(document.getElementById('satoshis').value);
                    const brl = parseFloat(document.getElementById('brl').value);
                    if (isNaN(satoshis) || isNaN(brl) || satoshis <= 0 || brl < 0) {
                        alert('Please enter valid satoshis and BRL amounts.');
                        console.log('Validation failed: Invalid satoshis or BRL');
                        return;
                    }
                    transaction = { date, type, satoshis, brl };
                } else {
                    const taxSatoshis = parseInt(document.getElementById('taxSatoshis').value);
                    if (isNaN(taxSatoshis) || taxSatoshis <= 0) {
                        alert('Please enter a valid tax amount in satoshis.');
                        console.log('Validation failed: Invalid tax satoshis');
                        return;
                    }
                    transaction = { date, type, taxSatoshis };
                }

                console.log('Adding transaction:', transaction);
                transactions.push(transaction);
                transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                try {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    console.log('Transaction saved to localStorage');
                } catch (error) {
                    alert('Error saving transaction: ' + error.message);
                    console.error('localStorage error:', error);
                    return;
                }
                updateSummary();
                renderHistory();
                console.log('Transaction added successfully');
            } catch (error) {
                alert('Error adding transaction: ' + error.message);
                console.error('Error in addTransaction:', error);
            }
        }

        function deleteTransaction(index) {
            console.log('Deleting transaction at index:', index);
            try {
                if (index < 0 || index >= transactions.length) {
                    alert('Invalid transaction index.');
                    console.log('Validation failed: Invalid index');
                    return;
                }
                transactions.splice(index, 1);
                try {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    console.log('Transaction deleted and saved to localStorage');
                } catch (error) {
                    alert('Error saving after deletion: ' + error.message);
                    console.error('localStorage error:', error);
                    return;
                }
                updateSummary();
                renderHistory();
                console.log('Transaction deleted successfully');
            } catch (error) {
                alert('Error deleting transaction: ' + error.message);
                console.error('Error in deleteTransaction:', error);
            }
        }

        function resetForm() {
            console.log('Resetting form');
            try {
                document.getElementById('date').value = '';
                document.getElementById('type').value = 'purchase';
                document.getElementById('satoshis').value = '';
                document.getElementById('brl').value = '';
                document.getElementById('taxSatoshis').value = '';
                toggleFields();
            } catch (error) {
                console.error('Error in resetForm:', error);
                alert('Error resetting form: ' + error.message);
            }
        }

        function updateSummary() {
            console.log('Updating summary');
            try {
                let totalSats = 0;
                let totalBRL = 0;

                transactions.forEach(t => {
                    if (t.type === 'purchase') {
                        totalSats += t.satoshis;
                        totalBRL += t.brl;
                    } else {
                        totalSats -= t.taxSatoshis;
                    }
                });

                const totalBTC = totalSats / 100000000;
                const avgPrice = totalBTC > 0 ? (totalBRL / totalBTC).toFixed(2) : 0;

                let profitLoss = 'N/A';
                if (livePrice && avgPrice > 0) {
                    const percentage = ((livePrice - avgPrice) / avgPrice) * 100;
                    profitLoss = percentage >= 0 ? `+${percentage.toFixed(2)}%` : `${percentage.toFixed(2)}%`;
                }

                document.getElementById('totalSats').textContent = `Total Satoshis: ${totalSats.toLocaleString()}`;
                document.getElementById('totalBRL').textContent = `Total BRL Spent: ${totalBRL.toFixed(2)}`;
                document.getElementById('avgPrice').textContent = `Average Price: ${avgPrice} BRL/BTC`;
                document.getElementById('profitLoss').textContent = `Profit/Loss: ${profitLoss}`;
            } catch (error) {
                console.error('Error in updateSummary:', error);
                alert('Error updating summary: ' + error.message);
            }
        }

        function renderHistory() {
            console.log('Rendering history');
            try {
                const historyDiv = document.getElementById('history');
                historyDiv.innerHTML = '';
                transactions.forEach((t, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-2 border-b flex justify-between items-center';
                    const text = t.type === 'purchase'
                        ? `${t.date}: Bought ${t.satoshis.toLocaleString()} sats for ${t.brl.toFixed(2)} BRL`
                        : `${t.date}: Paid ${t.taxSatoshis.toLocaleString()} sats in taxes`;
                    div.innerHTML = `
                        <span>${text}</span>
                        <button onclick="deleteTransaction(${index})" class="bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700">Delete</button>
                    `;
                    historyDiv.appendChild(div);
                });
            } catch (error) {
                console.error('Error in renderHistory:', error);
                alert('Error rendering history: ' + error.message);
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/chart.min.js"></script>
    <script>
        // Fallback to CDN if local Chart.js fails
        if (typeof Chart === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.min.js"><\/script>');
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-2xl font-bold text-center mb-6">Bitcoin Purchase Tracker</h1>

        <!-- Form for adding purchases or taxes -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Add Transaction</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="date" class="mt-1 block w-full p-2 border rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Transaction Type</label>
                    <select id="type" class="mt-1 block w-full p-2 border rounded-md" required>
                        <option value="purchase">Purchase</option>
                        <option value="tax">Tax</option>
                    </select>
                </div>
                <div id="purchaseFields">
                    <label class="block text-sm font-medium text-gray-700">Satoshis</label>
                    <input type="number" id="satoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 5000" required>
                    <label class="block text-sm font-medium text-gray-700 mt-2">Amount Paid (BRL)</label>
                    <input type="number" id="brl" min="0" step="0.01" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 100" required>
                </div>
                <div id="taxFields" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Tax Paid (Satoshis)</label>
                    <input type="number" id="taxSatoshis" min="1" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 100" required>
                </div>
                <button onclick="addTransaction()" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Add Transaction</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Summary</h2>
            <p id="totalSats" class="text-gray-700">Total Satoshis: 0</p>
            <p id="totalBRL" class="text-gray-700">Total BRL Spent: 0.00</p>
            <p id="avgPrice" class="text-gray-700">Average Price: 0 BRL/BTC</p>
            <p id="livePrice" class="text-gray-700">Live Price: Loading...</p>
            <p id="profitLoss" class="text-gray-700">Profit/Loss: N/A</p>
            <button onclick="fetchLivePrice()" class="mt-2 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">Retry Live Price</button>
        </div>

        <!-- Average Price Graph -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Average Price Over Time (BRL/BTC)</h2>
            <div id="graphContainer">
                <canvas id="avgPriceChart" style="max-height: 300px; width: 100%;"></canvas>
                <p id="graphFallback" class="text-gray-700 hidden">Graph unavailable. Average prices: <span id="avgPriceText"></span></p>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Transaction History</h2>
            <div id="history" class="space-y-2"></div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let chart;
        let livePrice = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            alert('App loaded. Checking Chart.js and Cointrader price...');
            try {
                updateSummary();
                renderHistory();
                setTimeout(initChart, 2000); // Delay chart init
                toggleFields();
                fetchLivePrice();
                setInterval(fetchLivePrice, 60000); // Update every 60 seconds
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error initializing app: ' + error.message);
            }
        });

        // Fetch live BRL/BTC price from Cointrader Monitor with CORS proxy
        async function fetchLivePrice() {
            console.log('Fetching live price from Cointrader...');
            try {
                const proxy = 'https://cors-anywhere.herokuapp.com/';
                const url = proxy + 'https://cointradermonitor.com/api/pbb/v1/ticker';
                const response = await fetch(url, {
                    mode: 'cors',
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                if (!data.last) throw new Error('Invalid Cointrader response: missing last price');
                livePrice = parseFloat(data.last).toFixed(2);
                console.log('Live price from Cointrader:', livePrice);
                document.getElementById('livePrice').textContent = `Live Price: ${livePrice} BRL/BTC`;
                updateSummary();
            } catch (error) {
                console.error('Error fetching live price:', error.message);
                livePrice = null;
                document.getElementById('livePrice').textContent = `Live Price: Unavailable (Error: ${error.message})`;
                updateSummary();
                setTimeout(fetchLivePrice, 10000); // Retry after 10 seconds
            }
        }

        // Toggle between purchase and tax fields
        document.getElementById('type').addEventListener('change', toggleFields);

        function toggleFields() {
            console.log('Toggling form fields');
            try {
                const type = document.getElementById('type').value;
                document.getElementById('purchaseFields').classList.toggle('hidden', type === 'tax');
                document.getElementById('taxFields').classList.toggle('hidden', type === 'purchase');
            } catch (error) {
                console.error('Error in toggleFields:', error);
                alert('Error toggling fields: ' + error.message);
            }
        }

        function addTransaction() {
            console.log('Add Transaction button clicked');
            try {
                const date = document.getElementById('date').value;
                const type = document.getElementById('type').value;
                let transaction;

                if (!date) {
                    alert('Please select a date.');
                    console.log('Validation failed: No date');
                    return;
                }

                if (type === 'purchase') {
                    const satoshis = parseInt(document.getElementById('satoshis').value);
                    const brl = parseFloat(document.getElementById('brl').value);
                    if (isNaN(satoshis) || isNaN(brl) || satoshis <= 0 || brl < 0) {
                        alert('Please enter valid satoshis and BRL amounts.');
                        console.log('Validation failed: Invalid satoshis or BRL');
                        return;
                    }
                    transaction = { date, type, satoshis, brl };
                } else {
                    const taxSatoshis = parseInt(document.getElementById('taxSatoshis').value);
                    if (isNaN(taxSatoshis) || taxSatoshis <= 0) {
                        alert('Please enter a valid tax amount in satoshis.');
                        console.log('Validation failed: Invalid tax satoshis');
                        return;
                    }
                    transaction = { date, type, taxSatoshis };
                }

                console.log('Adding transaction:', transaction);
                transactions.push(transaction);
                transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                try {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    console.log('Transaction saved to localStorage');
                } catch (error) {
                    alert('Error saving transaction: ' + error.message);
                    console.error('localStorage error:', error);
                    return;
                }
                updateSummary();
                renderHistory();
                updateChart();
                resetForm();
                console.log('Transaction added successfully');
            } catch (error) {
                alert('Error adding transaction: ' + error.message);
                console.error('Error in addTransaction:', error);
            }
        }

        function deleteTransaction(index) {
            console.log('Deleting transaction at index:', index);
            try {
                if (index < 0 || index >= transactions.length) {
                    alert('Invalid transaction index.');
                    console.log('Validation failed: Invalid index');
                    return;
                }
                transactions.splice(index, 1);
                try {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    console.log('Transaction deleted and saved to localStorage');
                } catch (error) {
                    alert('Error saving after deletion: ' + error.message);
                    console.error('localStorage error:', error);
                    return;
                }
                updateSummary();
                renderHistory();
                updateChart();
                console.log('Transaction deleted successfully');
            } catch (error) {
                alert('Error deleting transaction: ' + error.message);
                console.error('Error in deleteTransaction:', error);
            }
        }

        function resetForm() {
            console.log('Resetting form');
            try {
                document.getElementById('date').value = '';
                document.getElementById('type').value = 'purchase';
                document.getElementById('satoshis').value = '';
                document.getElementById('brl').value = '';
                document.getElementById('taxSatoshis').value = '';
                toggleFields();
            } catch (error) {
                console.error('Error in resetForm:', error);
                alert('Error resetting form: ' + error.message);
            }
        }

        function updateSummary() {
            console.log('Updating summary');
            try {
                let totalSats = 0;
                let totalBRL = 0;

                transactions.forEach(t => {
                    if (t.type === 'purchase') {
                        totalSats += t.satoshis;
                        totalBRL += t.brl;
                    } else {
                        totalSats -= t.taxSatoshis;
                    }
                });

                const totalBTC = totalSats / 100000000;
                const avgPrice = totalBTC > 0 ? (totalBRL / totalBTC).toFixed(2) : 0;

                let profitLoss = 'N/A';
                if (livePrice && avgPrice > 0) {
                    const percentage = ((livePrice - avgPrice) / avgPrice) * 100;
                    profitLoss = percentage >= 0 ? `+${percentage.toFixed(2)}%` : `${percentage.toFixed(2)}%`;
                }

                document.getElementById('totalSats').textContent = `Total Satoshis: ${totalSats.toLocaleString()}`;
                document.getElementById('totalBRL').textContent = `Total BRL Spent: ${totalBRL.toFixed(2)}`;
                document.getElementById('avgPrice').textContent = `Average Price: ${avgPrice} BRL/BTC`;
                document.getElementById('profitLoss').textContent = `Profit/Loss: ${profitLoss}`;
            } catch (error) {
                console.error('Error in updateSummary:', error);
                alert('Error updating summary: ' + error.message);
            }
        }

        function renderHistory() {
            console.log('Rendering history');
            try {
                const historyDiv = document.getElementById('history');
                historyDiv.innerHTML = '';
                transactions.forEach((t, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-2 border-b flex justify-between items-center';
                    const text = t.type === 'purchase'
                        ? `${t.date}: Bought ${t.satoshis.toLocaleString()} sats for ${t.brl.toFixed(2)} BRL`
                        : `${t.date}: Paid ${t.taxSatoshis.toLocaleString()} sats in taxes`;
                    div.innerHTML = `
                        <span>${text}</span>
                        <button onclick="deleteTransaction(${index})" class="bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700">Delete</button>
                    `;
                    historyDiv.appendChild(div);
                });
            } catch (error) {
                console.error('Error in renderHistory:', error);
                alert('Error rendering history: ' + error.message);
            }
        }

        function initChart() {
            console.log('Initializing chart');
            try {
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded');
                    alert('Chart.js not loaded. Showing text-based average prices.');
                    document.getElementById('avgPriceChart').classList.add('hidden');
                    document.getElementById('graphFallback').classList.remove('hidden');
                    updateChart(); // Update fallback text
                    return;
                }

                const ctx = document.getElementById('avgPriceChart').getContext('2d');
                if (!ctx) {
                    console.error('Canvas element not found');
                    alert('Canvas element not found. Showing text-based average prices.');
                    document.getElementById('avgPriceChart').classList.add('hidden');
                    document.getElementById('graphFallback').classList.remove('hidden');
                    updateChart(); // Update fallback text
                    return;
                }

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Average Price (BRL/BTC)',
                            data: [],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Date' } },
                            y: { title: { display: true, text: 'Average Price (BRL/BTC)' }, beginAtZero: false }
                        },
                        plugins: { legend: { display: true } }
                    }
                });
                console.log('Chart initialized');
                updateChart();
            } catch (error) {
                console.error('Error in initChart:', error);
                alert('Error initializing chart: ' + error.message);
                document.getElementById('avgPriceChart').classList.add('hidden');
                document.getElementById('graphFallback').classList.remove('hidden');
                updateChart(); // Update fallback text
            }
        }

        function updateChart() {
            console.log('Updating chart');
            try {
                let totalSats = 0;
                let totalBRL = 0;
                const labels = [];
                const avgPrices = [];
                let fallbackText = [];

                transactions.forEach(t => {
                    if (t.type === 'purchase') {
                        totalSats += t.satoshis;
                        totalBRL += t.brl;
                    } else {
                        totalSats -= t.taxSatoshis;
                    }

                    const totalBTC = totalSats / 100000000;
                    const avgPrice = totalBTC > 0 ? (totalBRL / totalBTC).toFixed(2) : 0;
                    labels.push(t.date);
                    avgPrices.push(avgPrice);
                    fallbackText.push(`${t.date}: ${avgPrice} BRL/BTC`);
                });

                if (chart) {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = avgPrices;
                    chart.update();
                    console.log('Chart updated');
                }

                // Update fallback text
                document.getElementById('avgPriceText').textContent = fallbackText.length > 0 ? fallbackText.join(', ') : 'No transactions';
            } catch (error) {
                console.error('Error in updateChart:', error);
                alert('Error updating chart: ' + error.message);
            }
        }
    </script>
</body>
</html>